<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Face Crop + BG Replace</title>
  <style>
    :root{--gap:14px;--radius:16px;--shadow:0 8px 24px rgba(0,0,0,.12)}
    body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:#0b1020;color:#eaf0ff;margin:0}
    header{padding:24px 20px;border-bottom:1px solid rgba(255,255,255,.08);position:sticky;top:0;background:#0b1020;z-index:10}
    h1{margin:0;font-size:clamp(18px,2vw,26px)}
    main{display:grid;grid-template-columns:360px 1fr;gap:var(--gap);padding:var(--gap)}
    @media (max-width:1000px){main{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.04));border:1px solid rgba(255,255,255,.1);border-radius:var(--radius);box-shadow:var(--shadow)}
    .pane{padding:16px}
    label{font-size:12px;opacity:.9}
    input[type="file"],button,input[type="range"],input[type="number"]{width:100%;margin-top:6px;margin-bottom:14px;border-radius:12px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.06);color:#eaf0ff;padding:10px 12px;outline:none}
    input[type="range"]{padding:0}
    button{cursor:pointer;font-weight:600;letter-spacing:.2px}
    button.primary{background:#5e7cff;border-color:#6e8bff}
    button.ghost{background:transparent;border-color:rgba(255,255,255,.2)}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .preview-wrap{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap);padding:var(--gap)}
    .preview{background:rgba(255,255,255,.03);border:1px dashed rgba(255,255,255,.15);border-radius:var(--radius);padding:12px;overflow:auto}
    canvas{max-width:100%;height:auto;border-radius:10px;background:#111}
    .row{display:flex;gap:10px;align-items:center}
    .hint{font-size:12px;opacity:.7}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);font-size:12px}
    footer{padding:20px;text-align:center;opacity:.7}
    .list{font-size:13px;line-height:1.5;opacity:.9}
    .error{color:#ffb4b4}
  </style>
  <!-- TensorFlow.js -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.19.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-wasm@4.19.0/dist/tf-backend-wasm.min.js"></script>
  <script src="https://unpkg.com/@tensorflow-models/blazeface@0.0.7/dist/blazeface.js"></script>
  <script src="https://unpkg.com/@tensorflow-models/body-pix@2.2.0/dist/body-pix.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</head>
<body>
  <header>
    <h1>Face Crop + Background Replace (Client-side)</h1>
    <div class="hint">Single/batch images • Face-aware crop • Adjustable crop + soft edge • Export PNG/ZIP</div>
  </header>

  <main>
    <section class="card pane" id="controls">
      <div>
        <label>1) Input images</label>
        <input id="imageFiles" type="file" accept="image/*" multiple />
        <div class="hint">For folder batch (Chromium): use directory selection.</div>
        <div class="row">
          <label class="chip"><input id="dirPicker" type="file" webkitdirectory style="display:none" /><span>Choose Folder…</span></label>
          <button class="ghost" id="btnFolder" type="button">Pick Folder</button>
        </div>
      </div>

      <!-- Sliders for all variables -->
      <div>
        <label>Aspect Ratio</label>
        <select id="aspectSel">
          <option value="1:1">1:1</option>
          <option value="5:6" selected>5:6</option>
          <option value="3:4">3:4</option>
          <option value="2:3">2:3</option>
        </select>
      </div>
      <div>
        <label>Output long edge</label>
        <input type="number" id="longEdge" value="1200" min="300" max="4000">
      </div>
      <div>
        <label>Zoom</label>
        <input type="range" id="zoom" min="0.8" max="2.0" step="0.01" value="1.18">
        <div class="hint">Current: <span id="zoomVal">1.18</span></div>
      </div>
      <div>
        <label>Vertical offset</label>
        <input type="range" id="yOffset" min="-0.5" max="0.5" step="0.01" value="0.06">
        <div class="hint">Current: <span id="yOffsetVal">0.06</span></div>
      </div>
      <div>
        <label>Edge feather (px)</label>
        <input type="range" id="feather" min="0" max="30" step="1" value="8">
        <div class="hint">Current: <span id="featherVal">8</span> px</div>
      </div>
      <div>
        <label>Edge gamma</label>
        <input type="range" id="gamma" min="0.5" max="2.0" step="0.05" value="1.3">
        <div class="hint">Current: <span id="gammaVal">1.3</span></div>
      </div>

      <div class="row">
        <button class="primary" id="btnProcess" type="button">Process Selected</button>
        <button class="ghost" id="btnZip" type="button" disabled>Download ZIP</button>
        <button class="ghost" id="btnClear" type="button">Clear</button>
      </div>
    </section>

    <section class="card">
      <div class="pane">
        <div class="row" style="justify-content:space-between;align-items:center">
          <h3 style="margin:0">Preview</h3>
          <span id="status" class="chip">Models: loading…</span>
        </div>
      </div>
      <div class="preview-wrap">
        <div class="preview"><h4>Source</h4><canvas id="srcCanvas" width="640" height="480"></canvas></div>
        <div class="preview"><h4>Result</h4><canvas id="outCanvas" width="640" height="480"></canvas></div>
      </div>
      <div class="pane"><div id="downloads" class="list"></div></div>
    </section>
  </main>

<script>
/* ---------- Runtime Variables (controlled by UI) ---------- */
let ASPECT = 5/6, OUTPUT_LONG = 1200, ZOOM = 1.18, Y_OFFSET = 0.06;
let FEATHER_PX = 8, EDGE_GAMMA = 1.3;
const MIME='image/png', FILE_PREFIX='output_', BG_SRC='bg.png', MAX_INPUT_SIDE=1600;

/* UI bindings */
document.getElementById('aspectSel').addEventListener('change',e=>{
  const [w,h]=e.target.value.split(':').map(Number);ASPECT=w/h;
});
document.getElementById('longEdge').addEventListener('input',e=>{OUTPUT_LONG=parseInt(e.target.value,10);});
document.getElementById('zoom').addEventListener('input',e=>{
  ZOOM=parseFloat(e.target.value);document.getElementById('zoomVal').textContent=ZOOM.toFixed(2);
});
document.getElementById('yOffset').addEventListener('input',e=>{
  Y_OFFSET=parseFloat(e.target.value);document.getElementById('yOffsetVal').textContent=Y_OFFSET.toFixed(2);
});
document.getElementById('feather').addEventListener('input',e=>{
  FEATHER_PX=parseInt(e.target.value,10);document.getElementById('featherVal').textContent=FEATHER_PX;
});
document.getElementById('gamma').addEventListener('input',e=>{
  EDGE_GAMMA=parseFloat(e.target.value);document.getElementById('gammaVal').textContent=EDGE_GAMMA.toFixed(2);
});

/* ---------- Helpers ---------- */
function clamp(v,min,max){return Math.min(max,Math.max(min,v));}
function createCanvas(w,h){const c=document.createElement('canvas');c.width=w;c.height=h;return c;}
function drawContain(ctx,imgW,imgH,canW,canH){const s=Math.min(canW/imgW,canH/imgH);return{dx:(canW-imgW*s)/2,dy:(canH-imgH*s)/2,dw:imgW*s,dh:imgH*s,scale:s};}
function loadImage(file){return new Promise(r=>{const rd=new FileReader();rd.onload=e=>{const i=new Image();i.onload=()=>r(i);i.src=e.target.result;};rd.readAsDataURL(file);});}
function scaleToMaxSide(img,maxSide){const w=img.width,h=img.height,side=Math.max(w,h);if(side<=maxSide)return img;const sc=maxSide/side,cw=Math.round(w*sc),ch=Math.round(h*sc);const c=createCanvas(cw,ch);c.getContext('2d',{willReadFrequently:true}).drawImage(img,0,0,cw,ch);return c;}

/* ---------- Models ---------- */
let blazefaceModel=null, bodyPixModel=null, hardBG=null;const statusEl=document.getElementById('status');
(async function init(){try{await tf.setBackend('wasm');}catch{}await tf.ready();if(tf.getBackend()!=='wasm')await tf.setBackend('webgl');
blazefaceModel=await blazeface.load();statusEl.textContent='Face: OK, Loading segmentation…';
bodyPixModel=await bodyPix.load({architecture:'MobileNetV1',outputStride:16,multiplier:0.75,quantBytes:2});
hardBG=await new Promise((res,rej)=>{const i=new Image();i.onload=()=>res(i);i.onerror=rej;i.src=BG_SRC;});
statusEl.textContent='Models: ready ✅';})();

/* ---------- Elements ---------- */
const srcCanvas=document.getElementById('srcCanvas'), outCanvas=document.getElementById('outCanvas');
const srcCtx=srcCanvas.getContext('2d',{willReadFrequently:true}), outCtx=outCanvas.getContext('2d',{willReadFrequently:true});
const imageFiles=document.getElementById('imageFiles'),dirPicker=document.getElementById('dirPicker');
const btnFolder=document.getElementById('btnFolder'),btnProcess=document.getElementById('btnProcess'),btnZip=document.getElementById('btnZip'),btnClear=document.getElementById('btnClear'),downloads=document.getElementById('downloads');

btnFolder.addEventListener('click',()=>dirPicker.click());
btnClear.addEventListener('click',()=>{srcCtx.clearRect(0,0,srcCanvas.width,srcCanvas.height);outCtx.clearRect(0,0,outCanvas.width,outCanvas.height);downloads.innerHTML='';btnZip.disabled=true;});
dirPicker.addEventListener('change',e=>{const dt=new DataTransfer();[...e.target.files].forEach(f=>{if(f.type.startsWith('image/'))dt.items.add(f);});imageFiles.files=dt.files;handleImmediatePreview();});
imageFiles.addEventListener('change',handleImmediatePreview);

async function handleImmediatePreview(){const files=[...(imageFiles.files||[])].filter(f=>f.type.startsWith('image/'));if(!files.length)return;const img=await loadImage(files[0]);const scaled=scaleToMaxSide(img,MAX_INPUT_SIDE);const fit=drawContain(srcCtx,scaled.width,scaled.height,srcCanvas.width,srcCanvas.height);srcCtx.clearRect(0,0,srcCanvas.width,srcCanvas.height);srcCtx.drawImage(scaled,fit.dx,fit.dy,fit.dw,fit.dh);}

btnProcess.addEventListener('click',async()=>{const files=[...(imageFiles.files||[])].filter(f=>f.type.startsWith('image/'));if(!files.length)return alert('Select images');if(!blazefaceModel||!bodyPixModel||!hardBG)return alert('Models/BG still loading');
downloads.innerHTML='';const zip=new JSZip();
for(let i=0;i<files.length;i++){try{const orig=await loadImage(files[i]),img=scaleToMaxSide(orig,MAX_INPUT_SIDE),W=img.width,H=img.height;
const preds=await blazefaceModel.estimateFaces(img,false);let faceBox={x:W*0.25,y:H*0.2,w:W*0.5,h:H*0.6};if(preds.length){let best=null,area=-1;for(const p of preds){const [x1,y1]=p.topLeft,[x2,y2]=p.bottomRight,w=x2-x1,h=y2-y1,a=w*h;if(a>area){area=a;best={x:x1,y:y1,w,h};}}if(best)faceBox=best;}
const faceCenter={cx:faceBox.x+faceBox.w/2,cy:faceBox.y+faceBox.h/2};const baseSize=Math.max(faceBox.w,faceBox.h)*(2.2/ZOOM);let cropW=baseSize,cropH=baseSize/ASPECT;let cropX=clamp(faceCenter.cx-cropW/2,0,W-cropW),cropY=clamp(faceCenter.cy-cropH/2+Y_OFFSET*cropH,0,H-cropH);
const seg=await bodyPixModel.segmentPerson(img,{internalResolution:'medium',segmentationThreshold:0.9});
const raw=bodyPix.toMask(seg,{r:0,g:0,b:0,a:255},{r:0,g:0,b:0,a:0});const rawC=createCanvas(W,H);rawC.getContext('2d').putImageData(raw,0,0);
const maskC=createCanvas(W,H),fctx=maskC.getContext('2d',{willReadFrequently:true});if(FEATHER_PX>0)fctx.filter=`blur(${FEATHER_PX}px)`;fctx.drawImage(rawC,0,0);
if(EDGE_GAMMA!==1){const id=fctx.getImageData(0,0,W,H),d=id.data;for(let p=0;p<d.length;p+=4){d[p+3]=Math.round(Math.pow(d[p+3]/255,EDGE_GAMMA)*255);}fctx.putImageData(id,0,0);}
const personC=createCanvas(W,H),pc=personC.getContext('2d',{willReadFrequently:true});pc.drawImage(img,0,0);pc.globalCompositeOperation='destination-in';pc.drawImage(maskC,0,0);
const targetW=ASPECT>=1?OUTPUT_LONG:Math.round(OUTPUT_LONG*ASPECT),targetH=ASPECT>=1?Math.round(OUTPUT_LONG/ASPECT):OUTPUT_LONG;outCanvas.width=targetW;outCanvas.height=targetH;
const bgScale=Math.max(targetW/hardBG.width,targetH/hardBG.height);outCtx.drawImage(hardBG,(targetW-hardBG.width*bgScale)/2,(targetH-hardBG.height*bgScale)/2,hardBG.width*bgScale,hardBG.height*bgScale);
const sc=Math.min(targetW/cropW,targetH/cropH),dw=cropW*sc,dh=cropH*sc;outCtx.drawImage(personC,cropX,cropY,cropW,cropH,(targetW-dw)/2,(targetH-dh)/2,dw,dh);
const dataUrl=outCanvas.toDataURL(MIME),outName=FILE_PREFIX+(i+1)+'.png';const link=document.createElement("a");link.href=dataUrl;link.download=outName;link.textContent="⬇ "+outName;downloads.appendChild(link);downloads.appendChild(document.createElement("br"));zip.file(outName,dataUrl.split(",")[1],{base64:true});
await tf.nextFrame();}catch(e){downloads.innerHTML+=`<p class="error">⚠️ Skipped "${files[i].name}": ${e.message}</p>`;await tf.nextFrame();}}btnZip.disabled=false;btnZip.onclick=async()=>{const blob=await zip.generateAsync({type:"blob"});saveAs(blob,"processed_images.zip");};});
</script>
</body>
</html>
